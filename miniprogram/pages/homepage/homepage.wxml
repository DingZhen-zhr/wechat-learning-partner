<!-- pages/homepage/homepage.wxml -->
<view class="homepage-container">
  
  <view class="greeting-card-wrapper">
    <greeting-card 
      greetingText="{{aiGreetingText}}"
      partnerAvatar="{{partnerAvatar}}"
      bind:tap="onGreetingCardTap"
    />
  </view>

  <view class="summary-card">
    <view class="summary-header">
      <text>今日速览</text>
    </view>
    <view class="summary-body">
      <view class="summary-item">
        <text class="value">{{ todayLearnedDuration }}</text>
        <text class="label">已学习时长</text>
      </view>
      <view class="summary-item">
        <text class="value">{{ planCompletionRate }}%</text>
        <text class="label">计划完成度</text>
      </view>
    </view>
    <view class="summary-footer">
      <progress-bar percentage="{{planCompletionRate}}" />
    </view>
  </view>

  <view class="plan-list-section">
    <view class="plan-list-header">
      <text>今日计划</text>
      <view class="add-plan-button" hover-class="button-hover-light" bindtap="openAddPlanModal">
        <image src="/images/icons/plus.png" />
      </view>
    </view>
    <scroll-view class="plan-list" scroll-y="true">
      <block wx:if="{{planList.length > 0}}">
        <!-- ===== 优化后的滑动删除结构 ===== -->
        <view 
          class="plan-item-container {{item.isDeleting ? 'deleting' : ''}}"
          wx:for="{{planList}}" 
          wx:key="id"
        >
          <view class="swipe-wrapper">
            <view 
              class="swipe-content" 
              style="transform: translateX({{item.x}}rpx);"
              bindtouchstart="onTouchStart"
              bindtouchmove="onTouchMove"
              bindtouchend="onTouchEnd"
              data-index="{{index}}"
            >
              <plan-item 
                subject="{{item.subject}}"
                duration="{{item.duration}}"
                status="{{item.status}}"
                bind:start="startFocus"
                data-item="{{item}}"
              />
            </view>
            <view class="delete-action" bindtap="handleDeletePlan" data-id="{{item.id}}">
              <image class="delete-icon" src="/images/icons/delete.png"/>
            </view>
          </view>
        </view>
      </block>
      <block wx:else>
        <view class="empty-list-tip">
          <image class="empty-icon" src="/images/icons/empty-list.png" mode="widthFix"></image>
          <text>还没有计划哦，快点击右上角添加吧！</text>
        </view>
      </block>
    </scroll-view>
  </view>

  <!-- 新增任务的弹窗 (Modal) -->
  <view class="modal-mask" wx:if="{{ showAddPlanModal }}" bindtap="closeAddPlanModal">
    <view class="add-plan-modal" catchtap="preventModalClose">
      <view class="modal-title">添加新计划</view>
      <view class="form-item">
        <text class="form-label">学习科目</text>
        <input class="form-input" placeholder="例如：高等数学" value="{{ newPlanSubject }}" bindinput="onSubjectInput" focus="{{true}}" />
      </view>
      <view class="form-item">
        <text class="form-label">专注时长 (分钟)</text>
        <input class="form-input" type="number" placeholder="例如：45" value="{{ newPlanDuration }}" bindinput="onDurationInput" />
      </view>
      <view class="modal-actions">
        <button class="modal-button cancel-button" hover-class="button-hover-dark" bindtap="closeAddPlanModal">取消</button>
        <button class="modal-button confirm-button" hover-class="button-hover-confirm" bindtap="handleAddNewPlan">确认添加</button>
      </view>
    </view>
  </view>
</view>